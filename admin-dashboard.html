<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TaskFlow</title>
    <!-- CSS CDNs -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
</head>
<body data-theme="light">
    <!-- Admin Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h4 class="mb-0">TaskFlow Admin</h4>
            <small class="text-muted" id="admin-email">Administrator</small>
        </div>
        
        <ul class="sidebar-menu">
            <li><a href="admin-dashboard.html" class="active"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
            <li><a href="admin-users.html"><i class="bi bi-people"></i> User Management</a></li>
            <li><a href="admin-teams.html"><i class="bi bi-diagram-3"></i> Team Management</a></li>
            <li><a href="admin-tasks.html"><i class="bi bi-list-task"></i> System Tasks</a></li>
            <li><a href="admin-analytics.html"><i class="bi bi-graph-up"></i> Analytics</a></li>
            <li><a href="admin-settings.html"><i class="bi bi-gear"></i> System Settings</a></li>
            <li><hr></li>
            <li><a href="dashboard.html"><i class="bi bi-arrow-left"></i> User Dashboard</a></li>
            <li><a href="#" id="admin-logout-btn"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
        </ul>
        
        <div class="mt-auto p-3">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <small>Theme</small>
                <button class="btn theme-toggle" onclick="toggleTheme()"></button>
            </div>
            
            <div class="user-role-badge text-center">
                <span class="role-badge role-admin">ADMIN</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="page-header">
            <div>
                <h1 class="h3 mb-1">Admin Dashboard</h1>
                <small class="text-muted">System Overview & Management</small>
            </div>
            
            <div class="d-flex gap-2 align-items-center">
                <div class="input-group" style="width: 300px;">
                    <input type="text" class="form-control" placeholder="Search users, teams, tasks...">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
                
                <button class="btn btn-danger" id="refresh-admin-data">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </header>

        <!-- Admin Stats -->
        <div class="container-fluid mt-4">
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="bi bi-people fs-1 text-primary"></i>
                        <div class="stats-number" id="admin-stat-users">0</div>
                        <div class="stats-label">Total Users</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="bi bi-diagram-3 fs-1 text-success"></i>
                        <div class="stats-number" id="admin-stat-teams">0</div>
                        <div class="stats-label">Active Teams</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="bi bi-list-task fs-1 text-warning"></i>
                        <div class="stats-number" id="admin-stat-tasks">0</div>
                        <div class="stats-label">Total Tasks</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="bi bi-exclamation-triangle fs-1 text-danger"></i>
                        <div class="stats-number" id="admin-stat-issues">0</div>
                        <div class="stats-label">Issues</div>
                    </div>
                </div>
            </div>

            <!-- User Role Distribution -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">User Role Distribution</h5>
                            <canvas id="role-chart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Quick Actions</h5>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="showCreateAdminModal()">
                                    <i class="bi bi-person-plus"></i> Create Admin
                                </button>
                                <button class="btn btn-outline-success" onclick="showPromoteUserModal()">
                                    <i class="bi bi-arrow-up-circle"></i> Promote User
                                </button>
                                <button class="btn btn-outline-warning" onclick="showSystemSettings()">
                                    <i class="bi bi-gear"></i> System Settings
                                </button>
                                <button class="btn btn-outline-danger" onclick="showMaintenanceModal()">
                                    <i class="bi bi-tools"></i> Maintenance
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Users -->
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">Recent Users</h5>
                                <a href="admin-users.html" class="btn btn-sm btn-outline-primary">View All</a>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Joined</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-users-table">
                                        <!-- Users will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">System Health</h5>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Storage Usage</span>
                                    <span id="storage-usage">0%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" id="storage-bar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Database Health</span>
                                    <span id="db-health">Good</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-success" id="db-bar" style="width: 100%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Active Users</span>
                                    <span id="active-users">0</span>
                                </div>
                            </div>
                            <div class="mt-4">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="runHealthCheck()">
                                    <i class="bi bi-heart-pulse"></i> Run Health Check
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Logs -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">System Logs</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearLogs()">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="system-logs" id="system-logs">
                                <!-- Logs will be loaded here -->
                                <div class="text-center py-4">
                                    <div class="loading-spinner"></div>
                                    <p class="mt-2 text-muted">Loading system logs...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Admin Modals -->
    <div class="modal fade" id="createAdminModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Admin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="create-admin-form">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Display Name</label>
                            <input type="text" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Temporary Password</label>
                            <input type="password" class="form-control" required>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="send-email">
                            <label class="form-check-label" for="send-email">
                                Send welcome email with credentials
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Create Admin</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Replace ALL these CDN links: -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/notiflix@3.2.6/dist/notiflix-aio-3.2.6.min.js"></script>
    
    <!-- App Scripts -->
    <script src="firebase-config.js"></script>
    <script src="app.js"></script>
    
    <script>
        // Admin Dashboard functionality
        document.addEventListener('DOMContentLoaded', async function() {
            // Verify admin access
            await verifyAdminAccess();
            
            // Load admin data
            await loadAdminDashboardData();
            
            // Setup event listeners
            setupAdminEventListeners();
        });
        
        async function verifyAdminAccess() {
            if (!currentUser || userData?.role !== 'admin') {
                Notiflix.Notify.failure('Access denied. Admin privileges required.');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                throw new Error('Admin access required');
            }
        }
        
        async function loadAdminDashboardData() {
            try {
                // Load users
                const users = await getUsersList(50);
                updateAdminStats(users);
                renderRecentUsers(users.slice(0, 10));
                
                // Load other data
                await loadSystemHealth();
                await loadSystemLogs();
                
                // Initialize charts
                initializeRoleChart(users);
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                showNotification('Failed to load admin dashboard data', 'error');
            }
        }
        
        function updateAdminStats(users) {
            const totalUsers = users.length;
            const admins = users.filter(u => u.role === 'admin').length;
            const leads = users.filter(u => u.role === 'lead').length;
            const members = users.filter(u => u.role === 'member').length;
            
            document.getElementById('admin-stat-users').textContent = totalUsers;
            document.getElementById('admin-stat-teams').textContent = '0'; // Will be updated with actual team count
            document.getElementById('admin-stat-tasks').textContent = '0'; // Will be updated with actual task count
            document.getElementById('admin-stat-issues').textContent = '0'; // Can be calculated
            
            // Update active users count
            const activeUsers = users.filter(u => {
                const lastLogin = u.lastLogin?.toDate ? u.lastLogin.toDate() : new Date(u.lastLogin);
                const hoursAgo = (new Date() - lastLogin) / (1000 * 60 * 60);
                return hoursAgo < 24; // Active within last 24 hours
            }).length;
            
            document.getElementById('active-users').textContent = activeUsers;
        }
        
        function renderRecentUsers(users) {
            const table = document.getElementById('recent-users-table');
            
            if (users.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <p class="text-muted">No users found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            users.forEach(user => {
                const joinDate = formatDate(user.createdAt);
                const roleBadge = `<span class="badge bg-${getRoleColor(user.role)}">${user.role}</span>`;
                
                html += `
                    <tr>
                        <td>${escapeHtml(user.displayName || 'N/A')}</td>
                        <td>${escapeHtml(user.email || 'N/A')}</td>
                        <td>${roleBadge}</td>
                        <td>${joinDate}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editUser('${user.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            table.innerHTML = html;
        }
        
        function initializeRoleChart(users) {
            const ctx = document.getElementById('role-chart').getContext('2d');
            const roleCounts = {
                admin: users.filter(u => u.role === 'admin').length,
                lead: users.filter(u => u.role === 'lead').length,
                member: users.filter(u => u.role === 'member').length
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Admins', 'Team Leads', 'Members'],
                    datasets: [{
                        data: [roleCounts.admin, roleCounts.lead, roleCounts.member],
                        backgroundColor: [
                            '#dc2626',
                            '#d97706',
                            '#059669'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        async function loadSystemHealth() {
            try {
                // Simulate health check
                const storageUsed = 65; // Percentage
                const dbHealth = 95; // Percentage
                
                document.getElementById('storage-usage').textContent = `${storageUsed}%`;
                document.getElementById('storage-bar').style.width = `${storageUsed}%`;
                document.getElementById('db-health').textContent = dbHealth >= 90 ? 'Good' : 'Warning';
                document.getElementById('db-bar').style.width = `${dbHealth}%`;
                document.getElementById('db-bar').className = `progress-bar bg-${dbHealth >= 90 ? 'success' : 'warning'}`;
                
            } catch (error) {
                console.error('Error loading system health:', error);
            }
        }
        
        async function loadSystemLogs() {
            try {
                const snapshot = await firebase.firestore()
                    .collection('activityLogs')
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                const logs = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const container = document.getElementById('system-logs');
                
                if (logs.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center py-4">No system logs</p>';
                    return;
                }
                
                let html = '<div class="list-group">';
                logs.forEach(log => {
                    const time = formatDate(log.timestamp);
                    html += `
                        <div class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <small class="mb-1">${escapeHtml(log.details || '')}</small>
                                <small class="text-muted">${time}</small>
                            </div>
                            <small class="text-muted">Action: ${log.action}</small>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading system logs:', error);
            }
        }
        
        function setupAdminEventListeners() {
            // Logout button
            document.getElementById('admin-logout-btn').addEventListener('click', logoutUser);
            
            // Refresh button
            document.getElementById('refresh-admin-data').addEventListener('click', async () => {
                await loadAdminDashboardData();
                showNotification('Admin data refreshed', 'success');
            });
            
            // Refresh logs button
            window.refreshLogs = loadSystemLogs;
            
            // Clear logs button
            window.clearLogs = async function() {
                const confirmed = await Notiflix.Confirm.show(
                    'Clear System Logs',
                    'Are you sure you want to clear all system logs? This action cannot be undone.',
                    'Clear All',
                    'Cancel'
                );
                
                if (confirmed) {
                    // Note: In production, you might want to archive logs instead of deleting
                    showNotification('Logs cleared', 'success');
                    document.getElementById('system-logs').innerHTML = '<p class="text-muted text-center py-4">No system logs</p>';
                }
            };
            
            // Health check button
            window.runHealthCheck = async function() {
                showNotification('Running system health check...', 'info');
                setTimeout(() => {
                    loadSystemHealth();
                    showNotification('Health check completed', 'success');
                }, 1500);
            };
        }
        
        function getRoleColor(role) {
            switch (role) {
                case 'admin': return 'danger';
                case 'lead': return 'warning';
                case 'member': return 'success';
                default: return 'secondary';
            }
        }
        
        // User management functions
        window.editUser = async function(userId) {
            const users = await getUsersList();
            const user = users.find(u => u.id === userId);
            
            if (user) {
                const newRole = prompt(`Change role for ${user.displayName} (current: ${user.role}):\n\nOptions: admin, lead, member`, user.role);
                
                if (newRole && ['admin', 'lead', 'member'].includes(newRole)) {
                    try {
                        await updateUserRole(userId, newRole);
                    } catch (error) {
                        showNotification(error.message, 'error');
                    }
                }
            }
        };
        
        window.deleteUser = async function(userId) {
            const confirmed = await Notiflix.Confirm.show(
                'Delete User',
                'Are you sure you want to delete this user? This action cannot be undone.',
                'Delete',
                'Cancel'
            );
            
            if (confirmed) {
                // Note: In production, you should handle user deletion properly
                // This might involve deleting from auth, firestore, and storage
                showNotification('User deletion would be implemented here', 'info');
            }
        };
        
        // Modal functions
        window.showCreateAdminModal = function() {
            const modal = new bootstrap.Modal(document.getElementById('createAdminModal'));
            modal.show();
        };
        
        window.showPromoteUserModal = function() {
            Notiflix.Notify.info('Promote user functionality would open here');
        };
        
        window.showSystemSettings = function() {
            Notiflix.Notify.info('System settings would open here');
        };
        
        window.showMaintenanceModal = function() {
            Notiflix.Notify.info('Maintenance tools would open here');
        };
    </script>
</body>
</html>