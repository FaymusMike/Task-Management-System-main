<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TaskFlow</title>
    <!-- CSS CDNs -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- In dashboard.html head section -->
    <script src="cloudinary-upload.js"></script>
</head>
<body data-theme="light">
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h4 class="mb-0">TaskFlow</h4>
            <small class="text-muted" id="user-email">Loading...</small>
        </div>
        
        <ul class="sidebar-menu">
            <li><a href="dashboard.html" class="active"><i class="bi bi-house"></i> Dashboard</a></li>
            <li><a href="tasks.html"><i class="bi bi-list-task"></i> My Tasks</a></li>
            <li><a href="kanban.html"><i class="bi bi-kanban"></i> Kanban Board</a></li>
            <li><a href="calendar.html"><i class="bi bi-calendar"></i> Calendar</a></li>
            <li data-role="lead"><a href="teams.html"><i class="bi bi-people"></i> Teams</a></li>
            <li><a href="analytics.html"><i class="bi bi-graph-up"></i> Analytics</a></li>
            <li><hr></li>
            <li><a href="profile.html"><i class="bi bi-person"></i> Profile</a></li>
            <li><a href="settings.html"><i class="bi bi-gear"></i> Settings</a></li>
            <li><a href="#" id="logout-btn"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
        </ul>
        
        <div class="mt-auto p-3">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <small>Theme</small>
                <button class="btn theme-toggle" onclick="toggleTheme()"></button>
            </div>
            
            <div class="user-role-badge text-center">
                <span class="role-badge" id="user-role-badge">Member</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="page-header">
            <div>
                <h1 class="h3 mb-1">Welcome, <span id="user-name">User</span></h1>
                <small class="text-muted" id="dashboard-date"></small>
            </div>
            
            <div class="d-flex gap-2 align-items-center">
                <!-- Notifications -->
                <div class="position-relative">
                    <button class="btn btn-outline-secondary position-relative" id="notifications-btn">
                        <i class="bi bi-bell"></i>
                        <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
                    </button>
                </div>
                
                <!-- Quick Actions -->
                <button class="btn btn-outline-primary" id="quick-task-btn">
                    <i class="bi bi-plus-lg"></i> Quick Task
                </button>
                
                <button class="btn btn-primary" id="new-task-btn">
                    <i class="bi bi-plus-circle"></i> New Task
                </button>
            </div>
        </header>

        <!-- Dashboard Content -->
        <div class="container-fluid mt-4">
            <!-- Stats Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="bi bi-list-task fs-1 text-primary"></i>
                        <div class="stats-number" id="stat-total">0</div>
                        <div class="stats-label">Total Tasks</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="bi bi-check-circle fs-1 text-success"></i>
                        <div class="stats-number" id="stat-completed">0</div>
                        <div class="stats-label">Completed</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="bi bi-clock fs-1 text-warning"></i>
                        <div class="stats-number" id="stat-progress">0</div>
                        <div class="stats-label">In Progress</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="bi bi-exclamation-triangle fs-1 text-danger"></i>
                        <div class="stats-number" id="stat-overdue">0</div>
                        <div class="stats-label">Overdue</div>
                    </div>
                </div>
            </div>

            <!-- Progress to Next Role -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Role Progress</h5>
                            <div id="role-progress-container">
                                <div class="progress-container">
                                    <div class="progress-label">
                                        <span>Team Lead Progress</span>
                                        <span id="team-lead-progress-text">0/5 team tasks completed</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="team-lead-progress-bar" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="progress-container mt-3" data-role="lead">
                                    <div class="progress-label">
                                        <span>Admin Progress</span>
                                        <span id="admin-progress-text">0/20 teams managed</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="admin-progress-bar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Tasks & Activity -->
            <div class="row g-4">
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">Recent Tasks</h5>
                                <a href="tasks.html" class="btn btn-sm btn-outline-primary">View All</a>
                            </div>
                            <div id="recent-tasks">
                                <!-- Tasks will be loaded here -->
                                <div class="text-center py-4">
                                    <div class="loading-spinner"></div>
                                    <p class="mt-2 text-muted">Loading tasks...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">Recent Activity</h5>
                                <button class="btn btn-sm btn-outline-secondary" id="refresh-activity">Refresh</button>
                            </div>
                            <div class="activity-log" id="recent-activity">
                                <!-- Activity logs will be loaded here -->
                                <div class="text-center py-4">
                                    <div class="loading-spinner"></div>
                                    <p class="mt-2 text-muted">Loading activity...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teams Section (for leads and admins) -->
            <div class="row mt-4" data-role="lead">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title mb-0">Your Teams</h5>
                                <button class="btn btn-sm btn-primary" id="create-team-btn">Create Team</button>
                            </div>
                            <div id="teams-list">
                                <!-- Teams will be loaded here -->
                                <div class="text-center py-4">
                                    <p class="text-muted">You are not managing any teams yet.</p>
                                    <button class="btn btn-outline-primary" id="create-first-team">Create Your First Team</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Task Modal -->
    <div class="modal fade task-modal" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="task-form">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Task Title *</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3" placeholder="Describe your task..."></textarea>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Priority</label>
                                <select class="form-select" name="priority" required>
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Due Date</label>
                                <input type="datetime-local" class="form-control" name="dueDate">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <input type="text" class="form-control" name="category" placeholder="Work, Personal, etc.">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Status</label>
                                <select class="form-select" name="status" required>
                                    <option value="todo" selected>To Do</option>
                                    <option value="progress">In Progress</option>
                                    <option value="done">Completed</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3 mt-3" data-role="lead">
                            <label class="form-label">Assign to Team (Optional)</label>
                            <select class="form-select" name="teamId" id="team-select">
                                <option value="">Personal Task</option>
                                <!-- Teams will be populated here -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Tags</label>
                            <input type="text" class="form-control" name="tags" placeholder="Add tags separated by commas">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Attachments</label>
                            <div class="file-upload-area border rounded p-3 text-center mb-2" 
                                id="file-drop-area"
                                style="border-style: dashed !important;">
                                <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                                <p class="mb-1">Drag & drop files here or click to browse</p>
                                <small class="text-muted">Supports images, PDFs, documents (max 10MB each)</small>
                                <input type="file" class="form-control d-none" id="task-attachments" multiple>
                            </div>
                            <div id="file-preview" class="mt-2"></div>
                            <small class="text-muted">Max file size: 10MB each</small>
                        </div>
                        
                        <!-- Subtasks -->
                        <div class="mb-3">
                            <label class="form-label">Subtasks</label>
                            <div id="subtasks-container">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control subtask-input" placeholder="Add a subtask">
                                    <button class="btn btn-outline-secondary" type="button" onclick="addSubtask()">Add</button>
                                </div>
                            </div>
                            <div id="subtasks-list"></div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Task Modal -->
    <div class="modal fade" id="quickTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Quick Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="quick-task-form">
                    <div class="modal-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" placeholder="What needs to be done?" required>
                        </div>
                        <div class="mb-3">
                            <select class="form-select" required>
                                <option value="low">Low Priority</option>
                                <option value="medium" selected>Medium Priority</option>
                                <option value="high">High Priority</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div class="modal fade" id="notificationsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Notifications</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="notifications-list">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-primary" id="mark-all-read">Mark All as Read</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Replace ALL these CDN links: -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/notiflix@3.2.6/dist/notiflix-aio-3.2.6.min.js"></script>
    
    <!-- App Scripts -->
    <script src="firebase-config.js"></script>
    <script src="app.js"></script>
    
    <script>
        // Dashboard-specific functionality
        document.addEventListener('DOMContentLoaded', async function() {
            // Set current date
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dashboard-date').textContent = now.toLocaleDateString('en-US', options);
            
            // Load user data
            await loadDashboardData();
            
            // Setup event listeners
            setupDashboardEventListeners();
            
            // Initialize real-time updates
            setupRealtimeDashboardUpdates();
        });
        
        async function loadDashboardData() {
            try {
                // Load tasks
                const tasks = await loadTasks();
                updateStats(tasks);
                renderRecentTasks(tasks.slice(0, 5));
                
                // Load activity
                await loadRecentActivity();
                
                // Load teams if user is lead/admin
                if (userData?.role === 'lead' || userData?.role === 'admin') {
                    await loadUserTeams();
                }
                
                // Update user info
                updateUserInfo();
                
                // Update role progress
                updateRoleProgress();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Failed to load dashboard data', 'error');
            }
        }
        
        function updateStats(tasks) {
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'done').length;
            const inProgress = tasks.filter(t => t.status === 'progress').length;
            const overdue = tasks.filter(t => {
                if (!t.dueDate) return false;
                const dueDate = t.dueDate.toDate ? t.dueDate.toDate() : new Date(t.dueDate);
                return dueDate < new Date() && t.status !== 'done';
            }).length;
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-progress').textContent = inProgress;
            document.getElementById('stat-overdue').textContent = overdue;
        }
        
        function renderRecentTasks(tasks) {
            const container = document.getElementById('recent-tasks');
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-inbox fs-1 text-muted"></i>
                        <p class="mt-2 text-muted">No tasks yet. Create your first task!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            tasks.forEach(task => {
                const dueDate = task.dueDate ? formatDate(task.dueDate) : 'No due date';
                const isOverdue = task.dueDate && 
                    new Date(task.dueDate.toDate ? task.dueDate.toDate() : task.dueDate) < new Date() && 
                    task.status !== 'done';
                
                html += `
                    <div class="task-card-small mb-2 p-3 border rounded">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="mb-1">${escapeHtml(task.title)}</h6>
                            <span class="badge bg-${getPriorityColor(task.priority)}">${task.priority}</span>
                        </div>
                        <p class="mb-2 text-muted small">${escapeHtml(task.description?.substring(0, 100) || 'No description')}${task.description?.length > 100 ? '...' : ''}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">${dueDate}</small>
                            <span class="badge bg-${task.status === 'done' ? 'success' : task.status === 'progress' ? 'warning' : 'secondary'}">
                                ${task.status}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function loadRecentActivity() {
            try {
                const activities = await getActivityLogs(10);
                const container = document.getElementById('recent-activity');
                
                if (activities.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center py-4">No recent activity</p>';
                    return;
                }
                
                let html = '';
                activities.forEach(activity => {
                    const timeAgo = formatTimeAgo(activity.timestamp);
                    html += `
                        <div class="activity-item">
                            <div class="d-flex justify-content-between">
                                <strong>${escapeHtml(activity.action.replace('_', ' ').toUpperCase())}</strong>
                                <small class="activity-time">${timeAgo}</small>
                            </div>
                            <div class="small text-muted">${escapeHtml(activity.details || '')}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading activity:', error);
            }
        }
        
        async function loadUserTeams() {
            try {
                const teams = await loadTeams();
                const container = document.getElementById('teams-list');
                const teamSelect = document.getElementById('team-select');
                
                if (teams.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <p class="text-muted">You are not managing any teams yet.</p>
                            <button class="btn btn-outline-primary" onclick="showCreateTeamModal()">Create Your First Team</button>
                        </div>
                    `;
                    
                    if (teamSelect) {
                        teamSelect.innerHTML = '<option value="">Personal Task</option>';
                    }
                    return;
                }
                
                // Update teams list
                let teamsHtml = '<div class="row g-3">';
                teams.forEach(team => {
                    teamsHtml += `
                        <div class="col-md-6">
                            <div class="team-card p-3 border rounded">
                                <h6>${escapeHtml(team.name)}</h6>
                                <small class="text-muted">${team.memberIds?.length || 0} members</small>
                                <div class="mt-2">
                                    <a href="team.html?id=${team.id}" class="btn btn-sm btn-outline-primary">View</a>
                                </div>
                            </div>
                        </div>
                    `;
                });
                teamsHtml += '</div>';
                container.innerHTML = teamsHtml;
                
                // Update team select dropdown
                if (teamSelect) {
                    let options = '<option value="">Personal Task</option>';
                    teams.forEach(team => {
                        options += `<option value="${team.id}">${escapeHtml(team.name)}</option>`;
                    });
                    teamSelect.innerHTML = options;
                }
            } catch (error) {
                console.error('Error loading teams:', error);
            }
        }
        
        function updateUserInfo() {
            if (!userData) return;
            
            document.getElementById('user-name').textContent = userData.displayName || 'User';
            document.getElementById('user-email').textContent = userData.email || '';
        }
        
        function updateRoleProgress() {
            if (!userData) return;
            
            const stats = userData.stats || {};
            
            // Team Lead progress
            const teamTasksCompleted = stats.teamTasksCompleted || 0;
            const teamLeadProgress = Math.min((teamTasksCompleted / 5) * 100, 100);
            
            document.getElementById('team-lead-progress-text').textContent = 
                `${teamTasksCompleted}/5 team tasks completed`;
            document.getElementById('team-lead-progress-bar').style.width = `${teamLeadProgress}%`;
            
            // Admin progress (only for leads)
            if (userData.role === 'lead') {
                const groupsManaged = stats.groupsManaged || 0;
                const adminProgress = Math.min((groupsManaged / 20) * 100, 100);
                
                document.getElementById('admin-progress-text').textContent = 
                    `${groupsManaged}/20 teams managed`;
                document.getElementById('admin-progress-bar').style.width = `${adminProgress}%`;
            }
        }
        
        function setupDashboardEventListeners() {
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', logoutUser);
            
            // New task button
            document.getElementById('new-task-btn').addEventListener('click', () => {
                const modal = new bootstrap.Modal(document.getElementById('taskModal'));
                modal.show();
            });
            
            // Quick task button
            document.getElementById('quick-task-btn').addEventListener('click', () => {
                const modal = new bootstrap.Modal(document.getElementById('quickTaskModal'));
                modal.show();
            });
            
            // Notifications button
            document.getElementById('notifications-btn').addEventListener('click', async () => {
                await showNotificationsModal();
            });
            
            // Refresh activity button
            document.getElementById('refresh-activity').addEventListener('click', loadRecentActivity);
            
            // Create team button
            const createTeamBtn = document.getElementById('create-team-btn');
            if (createTeamBtn) {
                createTeamBtn.addEventListener('click', showCreateTeamModal);
            }
            
            const createFirstTeamBtn = document.getElementById('create-first-team');
            if (createFirstTeamBtn) {
                createFirstTeamBtn.addEventListener('click', showCreateTeamModal);
            }
            
            // Task form submission
            const taskForm = document.getElementById('task-form');
            if (taskForm) {
                taskForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await handleTaskFormSubmit(taskForm);
                });
            }
            
            // Quick task form
            const quickTaskForm = document.getElementById('quick-task-form');
            if (quickTaskForm) {
                quickTaskForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await handleQuickTaskFormSubmit(quickTaskForm);
                });
            }
        }
        
        function setupRealtimeDashboardUpdates() {
            // Real-time task updates
            firebase.firestore().collection('tasks')
                .where('ownerId', '==', currentUser.uid)
                .onSnapshot((snapshot) => {
                    const updatedTasks = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    updateStats(updatedTasks);
                    renderRecentTasks(updatedTasks.slice(0, 5));
                });
            
            // Real-time notifications
            firebase.firestore().collection('notifications')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .limit(10)
                .onSnapshot((snapshot) => {
                    const unreadCount = snapshot.docs.filter(doc => !doc.data().read).length;
                    const badge = document.getElementById('notification-badge');
                    badge.textContent = unreadCount;
                    badge.style.display = unreadCount > 0 ? 'flex' : 'none';
                });
        }
        
        async function handleTaskFormSubmit(form) {
            const formData = new FormData(form);
            const taskData = {
                title: formData.get('title'),
                description: formData.get('description'),
                priority: formData.get('priority'),
                dueDate: formData.get('dueDate') || null,
                category: formData.get('category') || null,
                status: formData.get('status'),
                teamId: formData.get('teamId') || null,
                tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()) : []
            };
            
            try {
                await createTask(taskData);
                const modal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
                modal.hide();
                form.reset();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }
        
        async function handleQuickTaskFormSubmit(form) {
            const title = form.querySelector('input[type="text"]').value;
            const priority = form.querySelector('select').value;
            
            try {
                await createTask({
                    title: title,
                    priority: priority,
                    status: 'todo'
                });
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('quickTaskModal'));
                modal.hide();
                form.reset();
                
                showNotification('Quick task added!', 'success');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }
        
        async function showNotificationsModal() {
            try {
                await loadNotifications();
                const modal = new bootstrap.Modal(document.getElementById('notificationsModal'));
                
                // Render notifications
                const container = document.getElementById('notifications-list');
                if (notifications.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center py-4">No notifications</p>';
                } else {
                    let html = '';
                    notifications.forEach(notification => {
                        const timeAgo = formatTimeAgo(notification.createdAt);
                        html += `
                            <div class="notification-item p-3 border-bottom ${notification.read ? '' : 'bg-light'}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">${escapeHtml(notification.title)}</h6>
                                        <p class="mb-1 small">${escapeHtml(notification.message)}</p>
                                        <small class="text-muted">${timeAgo}</small>
                                    </div>
                                    ${!notification.read ? '<span class="badge bg-primary">New</span>' : ''}
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }
                
                // Mark all as read button
                document.getElementById('mark-all-read').addEventListener('click', async () => {
                    await markAllNotificationsAsRead();
                    modal.hide();
                });
                
                modal.show();
            } catch (error) {
                console.error('Error showing notifications:', error);
            }
        }
        
        function showCreateTeamModal() {
            // You can implement a team creation modal here
            const teamName = prompt('Enter team name:');
            if (teamName) {
                createTeam({ name: teamName })
                    .then(() => {
                        showNotification('Team created successfully!', 'success');
                        loadUserTeams();
                    })
                    .catch(error => {
                        showNotification(error.message, 'error');
                    });
            }
        }
        
        function getPriorityColor(priority) {
            switch (priority) {
                case 'high': return 'danger';
                case 'urgent': return 'dark';
                case 'medium': return 'warning';
                case 'low': return 'success';
                default: return 'secondary';
            }
        }

        
        // File upload handling
        function setupFileUpload() {
            const fileInput = document.getElementById('task-attachments');
            const dropArea = document.getElementById('file-drop-area');
            const previewArea = document.getElementById('file-preview');
            
            let files = [];
            
            // Click to browse
            dropArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
            
            // Drag and drop
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.style.backgroundColor = 'var(--gray-100)';
                dropArea.style.borderColor = 'var(--primary)';
            });
            
            dropArea.addEventListener('dragleave', () => {
                dropArea.style.backgroundColor = '';
                dropArea.style.borderColor = '';
            });
            
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.style.backgroundColor = '';
                dropArea.style.borderColor = '';
                
                if (e.dataTransfer.files.length) {
                    handleFiles(e.dataTransfer.files);
                }
            });
            
            function handleFiles(newFiles) {
                const validFiles = Array.from(newFiles).filter(file => {
                    const validation = cloudinaryUploader.validateFile(file);
                    if (!validation.valid) {
                        showNotification(validation.error, 'error');
                        return false;
                    }
                    return true;
                });
                
                files = [...files, ...validFiles];
                updateFilePreview();
            }
            
            function updateFilePreview() {
                previewArea.innerHTML = '';
                
                if (files.length === 0) {
                    return;
                }
                
                files.forEach((file, index) => {
                    const preview = document.createElement('div');
                    preview.className = 'attachment-item d-flex align-items-center justify-content-between mb-2 p-2 border rounded';
                    
                    const fileIcon = cloudinaryUploader.getFileIcon(file.type);
                    
                    preview.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="${fileIcon} me-2"></i>
                            <div>
                                <div class="small">${escapeHtml(file.name)}</div>
                                <div class="text-muted" style="font-size: 0.75rem;">
                                    ${formatFileSize(file.size)}
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-link text-danger" 
                                onclick="removeFile(${index})">
                            <i class="bi bi-x"></i>
                        </button>
                    `;
                    
                    previewArea.appendChild(preview);
                });
            }
            
            window.removeFile = function(index) {
                files.splice(index, 1);
                updateFilePreview();
            };
            
            window.getTaskFiles = function() {
                return files;
            };
            
            window.clearFiles = function() {
                files = [];
                updateFilePreview();
                fileInput.value = '';
            };
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Add to the initialization
        document.addEventListener('DOMContentLoaded', async function() {
            // ... existing code ...
            
            // Setup file upload
            setupFileUpload();
            
            // ... rest of the code ...
        });

        // Update the task form submission in dashboard.html
        async function handleTaskFormSubmit(form) {
            const formData = new FormData(form);
            const taskData = {
                title: formData.get('title'),
                description: formData.get('description'),
                priority: formData.get('priority'),
                dueDate: formData.get('dueDate') || null,
                category: formData.get('category') || null,
                status: formData.get('status'),
                teamId: formData.get('teamId') || null,
                tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()) : []
            };
            
            // Get subtasks
            const subtaskElements = document.querySelectorAll('.subtask-text');
            const subtasks = Array.from(subtaskElements).map(el => ({
                title: el.textContent,
                completed: false
            }));
            
            if (subtasks.length > 0) {
                taskData.subtasks = subtasks;
            }
            
            // Get files
            const files = window.getTaskFiles ? window.getTaskFiles() : [];
            
            try {
                // Show loading
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="loading-spinner me-2"></span> Creating...';
                submitBtn.disabled = true;
                
                await createTask(taskData, files);
                
                // Reset form
                form.reset();
                if (window.clearFiles) window.clearFiles();
                document.getElementById('subtasks-list').innerHTML = '';
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
                modal.hide();
                
                // Restore button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
            } catch (error) {
                showNotification(error.message, 'error');
                
                // Restore button on error
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.innerHTML = 'Create Task';
                submitBtn.disabled = false;
            }
        }
        
        // Make functions available globally
        window.renderTasks = renderRecentTasks;
        window.addSubtask = function() {
            const input = document.querySelector('.subtask-input');
            const value = input.value.trim();
            if (value) {
                const list = document.getElementById('subtasks-list');
                const item = document.createElement('div');
                item.className = 'subtask-item';
                item.innerHTML = `
                    <input type="checkbox" class="subtask-checkbox">
                    <span class="subtask-text">${escapeHtml(value)}</span>
                    <button class="btn btn-sm btn-link text-danger" onclick="this.parentElement.remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
                list.appendChild(item);
                input.value = '';
            }
        };
    </script>
</body>
</html>